{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Resultados Evaluaci√≥n {{ evaluation.year }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Compacto -->
    <div class="bg-gradient-to-r from-blue-800 to-blue-900 text-white rounded-xl shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold mb-1">Resultados de Evaluaci√≥n {{ evaluation.year }}</h1>
                <p class="text-blue-100 text-sm">{{ employee.full_name }} ‚Ä¢ {{ evaluation.employee.company.name }}</p>
                {% if evaluation.is_complete %}
                <p class="text-blue-100 text-sm">Completada el {{ evaluation.date_completed|date:"d/m/Y" }}</p>
                {% else %}
                <p class="text-blue-100 text-sm">üìã Vista Previa - A√∫n no enviada</p>
                {% endif %}
            </div>
            <div class="text-right">
                <div class="text-5xl font-bold mb-1
                    {% if summary.overall_risk == 'BAJO' %}text-green-200
                    {% elif summary.overall_risk == 'MEDIO' %}text-yellow-200
                    {% else %}text-red-200{% endif %}">
                    {{ summary.overall_risk }}
                </div>
                <p class="text-blue-100 text-sm">Riesgo General</p>
            </div>
        </div>
        
        <!-- Botones de Acci√≥n en la parte superior -->
        <div class="flex flex-wrap justify-center gap-3 pt-4 border-t border-blue-700">
            {% if evaluation.is_complete %}
            <a href="{% url 'employee_dashboard' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-semibold transition shadow-md flex items-center">
                <span class="mr-2">‚Üê</span>
                Volver al Dashboard
            </a>
            {% else %}
            <a href="{% url 'take_evaluation' evaluation.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-semibold transition shadow-md flex items-center">
                <span class="mr-2">‚Üê</span>
                Volver a Editar
            </a>
            {% endif %}
            
            {% if not evaluation.is_complete %}
            <a href="{% url 'submit_evaluation_from_results' evaluation.id %}" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg font-semibold transition shadow-md flex items-center" onclick="return confirm('¬øEst√°s seguro de que deseas enviar esta evaluaci√≥n definitivamente? No podr√°s editarla despu√©s sin usar tus ediciones disponibles.');">
                <span class="mr-2">‚úì</span>
                Enviar Evaluaci√≥n Definitivamente
            </a>
            {% endif %}
            
            <a href="{% url 'download_evaluation_pdf' evaluation.id %}" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-lg font-semibold transition shadow-md flex items-center">
                <span class="mr-2">‚Üì</span>
                Descargar PDF
            </a>
        </div>
    </div>

    <!-- Resumen Visual Compacto -->
    <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-green-700">{{ risk_counts.BAJO }}</div>
            <div class="text-sm text-green-600 font-semibold">Bajo</div>
        </div>
        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-yellow-700">{{ risk_counts.MEDIO }}</div>
            <div class="text-sm text-yellow-600 font-semibold">Medio</div>
        </div>
        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-red-700">{{ risk_counts.ALTO }}</div>
            <div class="text-sm text-red-600 font-semibold">Alto</div>
        </div>
    </div>

    <!-- Gr√°fico de Dimensiones -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div class="mb-4">
            <h2 class="text-xl font-bold text-slate-800">Visualizaci√≥n de Dimensiones</h2>
            <p class="text-sm text-slate-600 mt-1">Distribuci√≥n de niveles de riesgo por dimensi√≥n</p>
        </div>
        <div class="relative" style="height: 500px;">
            <canvas id="dimensionsChart"></canvas>
        </div>
        <div class="mt-4 flex justify-center space-x-6 text-sm">
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div>
                <span class="text-gray-700">Bajo Riesgo</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-yellow-500 mr-2"></div>
                <span class="text-gray-700">Medio Riesgo</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div>
                <span class="text-gray-700">Alto Riesgo</span>
            </div>
        </div>
    </div>

    <!-- Tabla Compacta de Dimensiones -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
            <h2 class="text-xl font-bold text-slate-800">Resumen por Dimensi√≥n</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Dimensi√≥n</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Puntaje</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Nivel</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase">Rangos</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for result in risk_results %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">{{ result.dimension.name }}</div>
                            <div class="text-xs text-gray-500">{{ result.dimension.description|truncatewords:8 }}</div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-lg font-bold text-slate-800">{{ result.score }}</span>
                            <span class="text-xs text-gray-500">/{{ result.question_count }} preguntas</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="inline-flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2
                                    {% if result.risk_level == 'BAJO' %}bg-green-500
                                    {% elif result.risk_level == 'MEDIO' %}bg-yellow-500
                                    {% else %}bg-red-500{% endif %}"></div>
                                <span class="text-sm font-semibold
                                    {% if result.risk_level == 'BAJO' %}text-green-700
                                    {% elif result.risk_level == 'MEDIO' %}text-yellow-700
                                    {% else %}text-red-700{% endif %}">
                                    {{ result.risk_level }}
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="text-xs space-y-1">
                                <div class="flex items-center justify-center">
                                    <span class="w-2 h-2 rounded-full bg-green-500 mr-1"></span>
                                    <span class="text-slate-600">BAJO: {{ result.dimension.low_risk_min }}-{{ result.dimension.low_risk_max }}</span>
                                </div>
                                <div class="flex items-center justify-center">
                                    <span class="w-2 h-2 rounded-full bg-yellow-500 mr-1"></span>
                                    <span class="text-slate-600">MEDIO: {{ result.dimension.medium_risk_min }}-{{ result.dimension.medium_risk_max }}</span>
                                </div>
                                <div class="flex items-center justify-center">
                                    <span class="w-2 h-2 rounded-full bg-red-500 mr-1"></span>
                                    <span class="text-slate-600">ALTO: {{ result.dimension.high_risk_min }}-{{ result.dimension.high_risk_max }}</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recomendaciones para Todas las Dimensiones -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-bold text-slate-800">Recomendaciones por Dimensi√≥n</h2>
            <p class="text-sm text-slate-600 mt-1">Sugerencias constructivas para mejorar tu bienestar laboral</p>
        </div>
        <div class="p-6">
            <div class="space-y-6">
                {% for result in risk_results %}
                {% with dim_recs=recommendations|get_item:result.dimension.name %}
                {% if dim_recs %}
                <div class="border-l-4 rounded-lg p-5 shadow-sm
                    {% if result.risk_level == 'BAJO' %}bg-green-50 border-green-400
                    {% elif result.risk_level == 'MEDIO' %}bg-yellow-50 border-yellow-400
                    {% else %}bg-red-50 border-red-400{% endif %}">
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="text-lg font-bold 
                            {% if result.risk_level == 'BAJO' %}text-green-900
                            {% elif result.risk_level == 'MEDIO' %}text-yellow-900
                            {% else %}text-red-900{% endif %}">
                            {{ result.dimension.name }}
                        </h3>
                        <span class="text-xs font-semibold px-3 py-1 rounded
                            {% if result.risk_level == 'BAJO' %}bg-green-500 text-white
                            {% elif result.risk_level == 'MEDIO' %}bg-yellow-500 text-white
                            {% else %}bg-red-500 text-white{% endif %}">
                            {{ result.risk_level }}
                        </span>
                    </div>
                    <div class="space-y-2">
                        {% for recommendation in dim_recs %}
                        <div class="flex items-start">
                            <span class="mr-2 mt-1
                                {% if result.risk_level == 'BAJO' %}text-green-600
                                {% elif result.risk_level == 'MEDIO' %}text-yellow-600
                                {% else %}text-red-600{% endif %}">‚Ä¢</span>
                            <p class="text-sm text-gray-700 flex-1">{{ recommendation }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Recomendaciones M√©dicas Ocupacionales -->
                    {% with med_recs=medical_recommendations|get_item:result.dimension.name %}
                    {% if med_recs %}
                    <div class="mt-4 pt-4 border-t {% if result.risk_level == 'BAJO' %}border-green-200{% elif result.risk_level == 'MEDIO' %}border-yellow-200{% else %}border-red-200{% endif %}">
                        <h4 class="text-sm font-bold mb-2
                            {% if result.risk_level == 'BAJO' %}text-green-800
                            {% elif result.risk_level == 'MEDIO' %}text-yellow-800
                            {% else %}text-red-800{% endif %}">
                            üè• Recomendaciones M√©dicas Ocupacionales
                        </h4>
                        <div class="space-y-2">
                            {% for med_rec in med_recs %}
                            <div class="flex items-start">
                                <span class="mr-2 mt-1 text-blue-600">‚Ä¢</span>
                                <p class="text-sm text-gray-700 flex-1">{{ med_rec }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>
                {% endif %}
                {% endwith %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Mensaje General -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-lg p-5 mb-6">
        <h3 class="text-lg font-bold text-blue-900 mb-2">üí° Mensaje General</h3>
        <div class="space-y-2 text-sm text-gray-700">
            {% if summary.overall_risk == 'ALTO' %}
            <p>‚Ä¢ Esta evaluaci√≥n identifica √°reas donde podemos trabajar juntos para mejorar tu bienestar laboral. Cada dimensi√≥n tiene oportunidades de mejora que pueden abordarse de manera colaborativa.</p>
            <p>‚Ä¢ Considera conversar con tu supervisor/a o recursos humanos sobre estas √°reas de manera constructiva, enfoc√°ndote en soluciones que beneficien a todos.</p>
            <p>‚Ä¢ Recuerda que tu bienestar es importante y que hay recursos disponibles para apoyarte en este proceso de mejora continua.</p>
            {% elif summary.overall_risk == 'MEDIO' %}
            <p>‚Ä¢ Tu evaluaci√≥n muestra algunas √°reas con oportunidades de mejora. Identifica las dimensiones espec√≠ficas donde puedes trabajar en conjunto con tu equipo.</p>
            <p>‚Ä¢ Establece metas concretas y alcanzables para mejorar estas dimensiones de manera colaborativa.</p>
            <p>‚Ä¢ Busca apoyo y recursos disponibles para fortalecer estas √°reas. El trabajo en equipo es clave para el √©xito.</p>
            {% else %}
            <p>‚Ä¢ ¬°Felicitaciones! Tu evaluaci√≥n muestra un buen equilibrio general. Contin√∫a manteniendo este nivel y aprovecha las fortalezas identificadas.</p>
            <p>‚Ä¢ Aunque el riesgo general es bajo, mant√©n la atenci√≥n en las dimensiones que pueden seguir mejor√°ndose. El crecimiento continuo beneficia a todos.</p>
            {% endif %}
        </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="flex flex-wrap justify-center gap-4 pb-6">
        {% if evaluation.is_complete %}
        <a href="{% url 'employee_dashboard' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
            ‚Üê Volver al Dashboard
        </a>
        {% else %}
        <a href="{% url 'take_evaluation' evaluation.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
            ‚Üê Volver a Editar
        </a>
        {% endif %}
        {% if evaluation.can_edit and evaluation.is_complete %}
        <a href="{% url 'take_evaluation' evaluation.id %}" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Editar Evaluaci√≥n ({{ evaluation.get_remaining_edits }} ediciones restantes)
        </a>
        {% elif not evaluation.is_complete %}
        <a href="{% url 'take_evaluation' evaluation.id %}" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Enviar Evaluaci√≥n Definitivamente
        </a>
        {% endif %}
        <a href="{% url 'download_evaluation_pdf' evaluation.id %}" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Descargar PDF
        </a>
        {% if completed_evaluations.count >= 2 %}
        <a href="{% url 'compare_evaluations' %}" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
            Comparar con Otros A√±os
        </a>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos de las dimensiones
    const dimensionsData = [
        {% for result in risk_results %}
        {
            name: "{{ result.dimension.name }}",
            score: {{ result.score }},
            riskLevel: "{{ result.risk_level }}",
            maxScore: {{ result.dimension.high_risk_max }},
            lowMax: {{ result.dimension.low_risk_max }},
            mediumMax: {{ result.dimension.medium_risk_max }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Funci√≥n para obtener el color seg√∫n el nivel de riesgo
    function getRiskColor(riskLevel) {
        if (riskLevel === 'BAJO') return '#10b981'; // green-500
        if (riskLevel === 'MEDIO') return '#eab308'; // yellow-500
        return '#ef4444'; // red-500
    }

    // Funci√≥n para obtener color de borde
    function getRiskBorderColor(riskLevel) {
        if (riskLevel === 'BAJO') return '#059669'; // green-600
        if (riskLevel === 'MEDIO') return '#ca8a04'; // yellow-600
        return '#dc2626'; // red-600
    }

    // Preparar datos para el gr√°fico
    const labels = dimensionsData.map(d => d.name);
    const scores = dimensionsData.map(d => d.score);
    const backgroundColors = dimensionsData.map(d => getRiskColor(d.riskLevel));
    const borderColors = dimensionsData.map(d => getRiskBorderColor(d.riskLevel));
    const maxScores = dimensionsData.map(d => d.maxScore);

    // Calcular el m√°ximo din√°mico: encontrar el puntaje m√°s alto y sumarle 5
    const maxScoreObtained = Math.max(...scores);
    const finalMaxX = maxScoreObtained + 5;

    // Crear el gr√°fico
    const ctx = document.getElementById('dimensionsChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Puntaje Obtenido',
                    data: scores,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const dataIndex = context.dataIndex;
                            const dimension = dimensionsData[dataIndex];
                            let label = 'Puntaje: ' + context.parsed.x;
                            label += ' (' + dimension.riskLevel + ' Riesgo)';
                            label += ' | Rango BAJO: 0-' + dimension.lowMax;
                            label += ' | MEDIO: ' + (dimension.lowMax + 1) + '-' + dimension.mediumMax;
                            label += ' | ALTO: ' + (dimension.mediumMax + 1) + '-' + dimension.maxScore;
                            return label;
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: finalMaxX,
                    ticks: {
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        color: '#6b7280',
                        stepSize: 1,
                        callback: function(value) {
                            // Mostrar todos los valores enteros
                            return Number.isInteger(value) ? value : '';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        color: '#374151',
                        maxRotation: 0,
                        minRotation: 0
                    },
                    grid: {
                        display: false
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });
});
</script>

<style>
    /* Asegurar que el contenido se vea bien en una sola pantalla */
    @media (min-height: 900px) {
        .max-w-7xl {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
    }
</style>
{% endblock %}
